events {}

http {
    # =====================
    # UPSTREAMS
    # =====================
    upstream users_service {
        server users-service:3001;
    }

    upstream movies_service {
        server movies-service:3002;
    }

    upstream playlists_service {
        server playlists-service:3003;
    }

    upstream products_service {
        server products-service:3004;
    }

    upstream auth_service {
        server auth:3005;
    }

    server {
        listen 80;

        # =====================
        # INTERNAL AUTH CHECK
        # =====================
        location = /_auth_admin {
            internal;
            proxy_pass http://auth_service/verify-admin;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
        }

        # =====================
        # USERS (PARTIAL PUBLIC)
        # =====================
        
        # 1. Public Login/Register
        # Matches /api/users/login -> Sends /users/login to users_service
        location /api/users/login {
            proxy_pass http://users_service/users/login;
        }

        location /api/users/register {
            proxy_pass http://users_service/users/register;
        }

        # 2. Protected User Routes
        # Matches /api/users/... -> Sends /users/... to users_service
        location /api/users {
            auth_request /_auth_admin;
            proxy_set_header X-User-Id $upstream_http_x_user_id;
            proxy_pass http://users_service/users;
        }

        # =====================
        # MOVIES (ADMIN ONLY)
        # =====================
        location /api/movies {
            auth_request /_auth_admin;
            proxy_set_header X-User-Id $upstream_http_x_user_id;
            proxy_pass http://movies_service/movies;
        }

        # =====================
        # PRODUCTS (ADMIN ONLY)
        # =====================
        location /api/products {
            auth_request /_auth_admin;
            proxy_pass http://products_service/products;
        }

        # =====================
        # PLAYLISTS (PUBLIC)
        # =====================
        location /api/playlists {
            proxy_pass http://playlists_service/playlists;
        }

        # =====================
        # DEFAULT
        # =====================
        location / {
            return 404 "API Gateway: Route not found";
        }
    }
}